<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.1.5/dist/mindar-image.prod.js"></script>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
     <script src="https://cdnjs.cloudflare.com/ajax/libs/stats.js/16/Stats.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.1.5/dist/mindar-image-aframe.prod.js"></script>
    <style>
      body {
        margin: 0;
      }
      .example-container {
        overflow: hidden;
        position: absolute;
        width: 100%;
        height: 100%;
      }
    </style>
  </head>
  <body>
    <div class="example-container">
      <div id="snow-fall"></div>
      <a-scene mindar-image="imageTargetSrc: https://cdn.glitch.global/bbe3a632-6215-4dfb-8a9d-3331f43617ff/targetsbaruprisma.mind?v=1670292239492; filterMinCF:0.0001; filterBeta: 0.01; showStats: true;" color-space="sRGB" renderer="colorManagement: true, physicallyCorrectLights" vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false">
        <a-assets>
          <a-asset-item id="birdModel" src="https://cdn.glitch.global/bbe3a632-6215-4dfb-8a9d-3331f43617ff/ChristmasTree.glb?v=1669992442385"></a-asset-item>
        </a-assets>

        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

        <a-entity listener mindar-image-target="targetIndex: 0">
          <a-gltf-model rotation="90 90 90" position="0 0 0" scale="0.15 0.15 0.15" src="#birdModel" animation-mixer>
        </a-entity>
      </a-scene>
    </div>
    
    <script>
      var audio = new Audio('https://cdn.glitch.global/bbe3a632-6215-4dfb-8a9d-3331f43617ff/Christmasmp3.mp3?v=1670040912889');
      var UserInteracted = setInterval(()=>{
        audio.play()
        .then(()=>{
          clearInterval(UserInteracted);
        })
        .catch(()=>{
          console.log("waiting for user interaction to play first notification")
        });     
      }, 3000)
    </script>
    <script type="text/javascript" src="particles.js"></script>
    <script type="text/javascript" src="app.js"></script>
    <script>
      AFRAME.registerComponent("listener", {
      init: function() {
        this.target = document.querySelector('#target'); // your video
        this.prevPosition = null; // initially there is no position or rotation
        this.prevRotation = null;
      },

      tick: function() {
        if (this.el.object3D.visible) {
          this.target.setAttribute('visible', 'true')

          if(!this.prevPosition && !this.prevRotation) { 
            // there are no values to lerp from - set the initial values
            this.target.setAttribute('position', this.el.getAttribute('position'))
            this.target.setAttribute('rotation', this.el.getAttribute('rotation'))
          } else {
            // use the previous values to get an approximation 
            this.target.object3D.position.lerp(this.prevPosition, 0.1)

            // this (below) may seem ugly, but the rotation is a euler, not a THREE.Vector3, 
            // so to use the lerp function i'm doing some probably unnecessary conversions
            let rot = this.target.object3D.rotation.toVector3().lerp(this.prevRotation, 0.1)
            this.target.object3D.rotation.setFromVector3(rot)
          }
          // update the values
          this.prevPosition = this.el.object3D.position
          this.prevRotation = this.el.object3D.rotation
        } else {
         // the marker dissapeared - reset the values
         this.target.setAttribute('visible', 'false')
         this.prevPosition = null;
         this.prevRotation = null;
       }
      }
    })  
    </script>
  </body>
</html>
